<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Warrior's Timetable</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a2e;
            color: #e0e0e0;
        }
        .container {
            max-width: 90%;
        }
        .glass-container {
            display: flex;
            align-items: flex-end;
            width: 70px;
            height: 100px;
            border: 2px solid #3366ff;
            border-radius: 0 0 15px 15px;
            position: relative;
            overflow: hidden;
            background-color: rgba(255, 255, 255, 0.1);
        }
        .glass-fill {
            width: 100%;
            transition: height 0.5s ease-in-out;
            background-color: #3366ff;
            position: absolute;
            bottom: 0;
            left: 0;
            border-radius: 0 0 13px 13px;
        }
        .glass-lines {
            height: 100%;
            width: 100%;
            position: absolute;
            display: flex;
            flex-direction: column-reverse;
            justify-content: space-around;
            padding-bottom: 5px;
        }
        .glass-line {
            width: 100%;
            height: 1px;
            background-color: #e0e0e0;
            opacity: 0.5;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: #162447;
            padding: 2rem;
            border-radius: 15px;
            text-align: center;
            max-width: 90%;
            color: #e0e0e0;
            border: 2px solid #3366ff;
        }
        .glow {
            box-shadow: 0 0 10px #facc15, 0 0 20px #facc15, 0 0 30px #facc15;
        }
        .bar-chart-container {
            display: flex;
            justify-content: space-around;
            align-items: flex-end;
            height: 150px;
            background-color: #2c3e50;
            border-radius: 10px;
            padding: 10px;
        }
        .bar {
            width: 10%;
            background-color: #3498db;
            transition: height 0.5s ease-in-out;
            border-radius: 5px 5px 0 0;
        }
        /* New styling for horizontal scrolling water glasses */
        #water-glasses-container {
            overflow-x: auto;
            white-space: nowrap;
            padding-bottom: 10px;
            justify-content: flex-start;
        }
        .glass-container {
            flex-shrink: 0;
            margin-right: 10px;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 flex flex-col items-center min-h-screen p-4">

    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed top-0 left-0 w-full h-full bg-gray-900 flex items-center justify-center text-gray-400 text-lg z-50">
        Loading...
    </div>

    <!-- Login Modal -->
    <div id="login-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-2xl font-bold mb-4 text-blue-400">Welcome, Warrior</h3>
            <p class="text-sm text-gray-400 mb-4">You're ready to master your day.</p>
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="username" class="block text-left text-sm font-medium text-gray-300">Enter your name</label>
                    <input type="text" id="username" name="username" required class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white p-2">
                </div>
                <button type="submit" class="w-full py-3 px-4 bg-blue-600 hover:bg-blue-700 transition-colors duration-200 rounded-2xl font-bold shadow-md">
                    Start Your Day
                </button>
            </form>
        </div>
    </div>

    <!-- Main Application Container -->
    <div id="app-container" class="container w-full h-full flex flex-col hidden">
        <div class="flex-1 w-full overflow-y-auto pb-20">
            <!-- Home Tab -->
            <div id="home-tab">
                <div class="container text-center py-8">
                    <h1 class="text-4xl md:text-5xl font-extrabold text-blue-500 mb-2 drop-shadow-lg">Today's Mission</h1>
                    <p class="text-md md:text-lg text-gray-400">Master your day, one task at a time.</p>
                    <!-- Quote of the Day -->
                    <div class="w-full text-center p-4 rounded-xl border border-blue-500 bg-gray-900 shadow-xl mt-4">
                        <p id="quote-of-the-day" class="text-sm italic text-gray-300">"The only way to do great work is to love what you do."</p>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full">
                    <!-- Timetable Section -->
                    <div class="bg-gray-800 p-6 rounded-3xl shadow-lg border border-gray-700">
                        <h2 class="text-2xl font-bold mb-4 text-blue-400">Today's Routines</h2>
                        <div id="timetable-list" class="space-y-4"></div>
                        <button id="add-routine-btn" class="w-full mt-6 py-3 px-4 bg-blue-600 hover:bg-blue-700 transition-colors duration-200 rounded-2xl font-bold shadow-md">
                            <i class="fas fa-plus mr-2"></i> Add New Routine
                        </button>
                    </div>

                    <!-- Side Sections -->
                    <div class="flex flex-col space-y-6">
                        <!-- Hydration Section -->
                        <div class="bg-gray-800 p-6 rounded-3xl shadow-lg border border-gray-700 flex flex-col items-center">
                            <h3 class="text-xl font-bold mb-4 text-blue-400">Hydration</h3>
                            <div id="water-glasses-container" class="flex items-end space-x-4 mb-4">
                                <!-- Glasses will be dynamically added here -->
                            </div>
                            <p class="text-sm text-gray-400 mb-2">Total glasses: <span id="water-count">0</span></p>
                            <button id="drink-water-btn" class="w-full py-2 px-6 bg-blue-600 hover:bg-blue-700 transition-colors duration-200 rounded-2xl font-bold shadow-md text-sm">
                                Drink Water <i class="fas fa-glass-water ml-1"></i>
                            </button>
                        </div>
                        
                        <!-- Exercise Section -->
                        <div class="bg-gray-800 p-6 rounded-3xl shadow-lg border border-gray-700">
                            <h3 class="text-xl font-bold mb-4 text-blue-400">Exercise</h3>
                            <div class="flex flex-col items-center">
                                <p class="text-sm text-gray-400 mb-2">Today's time: <span id="exercise-count">0h 0m</span></p>
                                <input type="number" id="exercise-time-input" placeholder="Minutes" class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white p-2">
                                <button id="add-exercise-btn" class="w-full mt-4 py-2 px-6 bg-green-600 hover:bg-green-700 transition-colors duration-200 rounded-2xl font-bold shadow-md text-sm">
                                    Log Exercise
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profile Tab -->
            <div id="profile-tab" class="hidden">
                <div class="container text-center py-8">
                    <h1 class="text-4xl md:text-5xl font-extrabold text-blue-500 mb-2 drop-shadow-lg">My Profile</h1>
                    <p class="text-md md:text-lg text-gray-400">Welcome, <span id="profile-username" class="font-bold"></span></p>
                </div>
                <div class="bg-gray-800 p-6 rounded-3xl shadow-lg border border-gray-700 mb-6">
                    <h2 class="text-2xl font-bold mb-4 text-blue-400">Weekly Streak</h2>
                    <div id="streak-days" class="flex justify-around items-center"></div>
                </div>
                <button id="logout-btn" class="w-full py-3 px-4 bg-red-600 hover:bg-red-700 transition-colors duration-200 rounded-2xl font-bold shadow-md">
                    Logout
                </button>
            </div>

            <!-- Analytics Tab -->
            <div id="analytics-tab" class="hidden">
                <div class="container text-center py-8">
                    <h1 class="text-4xl md:text-5xl font-extrabold text-blue-500 mb-2 drop-shadow-lg">My Analytics</h1>
                    <p class="text-md md:text-lg text-gray-400">Track your progress and wins.</p>
                </div>
                <div id="analytics-content" class="bg-gray-800 p-6 rounded-3xl shadow-lg border border-gray-700"></div>
            </div>

        </div>

        <!-- Navigation Bar -->
        <nav class="fixed bottom-0 left-0 right-0 bg-gray-800 border-t border-gray-700 shadow-lg z-50">
            <ul class="flex justify-around py-2">
                <li><button data-tab="home" class="tab-btn flex flex-col items-center text-gray-400 hover:text-blue-500 transition-colors duration-200 text-sm p-2"><i class="fas fa-home text-xl mb-1"></i>Home</button></li>
                <li><button data-tab="profile" class="tab-btn flex flex-col items-center text-gray-400 hover:text-blue-500 transition-colors duration-200 text-sm p-2"><i class="fas fa-user text-xl mb-1"></i>Profile</button></li>
                <li><button data-tab="analytics" class="tab-btn flex flex-col items-center text-gray-400 hover:text-blue-500 transition-colors duration-200 text-sm p-2"><i class="fas fa-chart-line text-xl mb-1"></i>Analytics</button></li>
            </ul>
        </nav>

        <!-- Task Creation Modal -->
        <div id="routine-modal" class="modal-overlay">
            <div class="modal-content">
                <h3 class="text-2xl font-bold mb-4 text-blue-400">Create a New Routine</h3>
                <form id="routine-form" class="space-y-4">
                    <div>
                        <label for="routine-name" class="block text-left text-sm font-medium text-gray-300">Routine Name</label>
                        <input type="text" id="routine-name" name="routine-name" required class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white p-2">
                    </div>
                    <div class="flex space-x-4">
                        <div class="flex-1">
                            <label for="start-time" class="block text-left text-sm font-medium text-gray-300">Start Time</label>
                            <input type="time" id="start-time" name="start-time" required class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white p-2">
                        </div>
                        <div class="flex-1">
                            <label for="end-time" class="block text-left text-sm font-medium text-gray-300">End Time</label>
                            <input type="time" id="end-time" name="end-time" required class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white p-2">
                        </div>
                    </div>
                    <div>
                        <label for="alarm-message" class="block text-left text-sm font-medium text-gray-300">Alarm Message</label>
                        <textarea id="alarm-message" name="alarm-message" rows="3" class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white p-2" placeholder="e.g., 'You are running out of time, start your revision now!'"></textarea>
                    </div>
                    <div class="flex space-x-4">
                        <div class="flex-1">
                            <label for="routine-day" class="block text-left text-sm font-medium text-gray-300">Day</label>
                            <select id="routine-day" name="routine-day" required class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white p-2">
                                <option value="today">Today</option>
                                <option value="tomorrow">Tomorrow</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="w-full py-3 px-4 bg-green-600 hover:bg-green-700 transition-colors duration-200 rounded-2xl font-bold shadow-md">
                        Add Routine
                    </button>
                </form>
                <button id="close-routine-modal-btn" class="mt-4 text-sm text-gray-400 hover:text-gray-200">Cancel</button>
            </div>
        </div>

        <!-- Alarm/Reminder Modal -->
        <div id="alarm-modal" class="modal-overlay">
            <div class="modal-content bg-red-900 border-red-500">
                <h3 class="text-2xl font-bold mb-2 text-red-300">Time to Rise!</h3>
                <p id="alarm-message" class="text-lg mb-4 text-gray-100"></p>
                <button id="close-alarm-btn" class="py-2 px-6 bg-red-600 hover:bg-red-700 transition-colors duration-200 rounded-2xl font-bold">
                    I'm a Warrior
                </button>
            </div>
        </div>

        <!-- Burnout Message -->
        <div id="burnout-message" class="fixed bottom-24 w-11/12 md:w-1/3 p-4 rounded-xl border border-red-500 bg-red-900 bg-opacity-30 shadow-xl hidden text-center">
            <p class="text-sm md:text-md text-red-300 italic">"Do not burn out, you are a warrior I know."</p>
        </div>
    </div>
</body>
<script>
    // --- LOCAL STORAGE FUNCTIONS ---
    function saveState() {
        localStorage.setItem('userData', JSON.stringify(userData));
    }

    function loadState() {
        const savedData = localStorage.getItem('userData');
        return savedData ? JSON.parse(savedData) : null;
    }

    // --- GLOBAL APP STATE ---
    let userData = {
        routines: [],
        water: 0,
        exercise: 0,
        streak: {
            days: Array(7).fill('cross'),
            lastUpdated: ''
        },
        analytics: {
            daily: {},
        },
        profile: {
            username: ''
        }
    };
    let currentTab = 'home';
    let userLoggedIn = false;
    let notifiedRoutines = {}; // To track which routines have already triggered an alarm
    let today = new Date().toISOString().slice(0, 10);

    // DOM Elements
    const appContainer = document.getElementById('app-container');
    const loadingScreen = document.getElementById('loading-screen');
    const loginModal = document.getElementById('login-modal');
    const loginForm = document.getElementById('login-form');
    const timetableList = document.getElementById('timetable-list');
    const waterCountDisplay = document.getElementById('water-count');
    const waterGlassesContainer = document.getElementById('water-glasses-container');
    const exerciseCountDisplay = document.getElementById('exercise-count');
    const streakDays = document.getElementById('streak-days');
    const analyticsContent = document.getElementById('analytics-content');
    const alarmModal = document.getElementById('alarm-modal');
    const alarmMessageEl = document.getElementById('alarm-message');
    const burnoutMessageEl = document.getElementById('burnout-message');
    const drinkWaterBtn = document.getElementById('drink-water-btn');
    const usernameInput = document.getElementById('username');
    const quoteOfTheDayEl = document.getElementById('quote-of-the-day');
    const addRoutineBtn = document.getElementById('add-routine-btn');
    const routineModal = document.getElementById('routine-modal');
    const closeRoutineModalBtn = document.getElementById('close-routine-modal-btn');
    const routineForm = document.getElementById('routine-form');
    const routineDaySelect = document.getElementById('routine-day');
    const homeRoutineTitle = document.querySelector('#home-tab h2');

    // Quotes and messages
    const motivationalQuotes = [
        "The only way to do great work is to love what you do. - Steve Jobs",
        "The future belongs to those who believe in the beauty of their dreams. - Eleanor Roosevelt",
        "The best way to predict the future is to create it. - Peter Drucker",
        "Don't watch the clock; do what it does. Keep going. - Sam Levenson",
        "Believe you can and you're halfway there. - Theodore Roosevelt"
    ];

    const motivationalMessages = [
        "You improved {percent}% from yesterday! Keep pushing!",
        "Great job, you're on a roll!",
        "Today's victory is built on yesterday's effort.",
        "You are a force to be reckoned with. Keep going!"
    ];
    const burnoutQuote = "Do not burn out, you are a warrior I know.";

    // --- CORE FUNCTIONS ---
    function handleDailyReset() {
        const newToday = new Date().toISOString().slice(0, 10);
        if (userData.streak.lastUpdated !== newToday) {
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayKey = yesterday.toISOString().slice(0, 10);

            const yesterdayData = {
                water: userData.water || 0,
                exercise: userData.exercise || 0,
                routinesCompleted: userData.routines.filter(r => r.completed && r.day === yesterdayKey).length,
                totalFocusTime: calculateTotalFocusTime(yesterdayKey),
            };
            userData.analytics.daily[yesterdayKey] = yesterdayData;

            const isStreakDay = (yesterdayData.routinesCompleted > 0 || yesterdayData.exercise > 0 || yesterdayData.water >= 4);
            const newStreak = [...userData.streak.days];
            newStreak.shift();
            newStreak.push(isStreakDay ? 'lit' : 'cross');
            userData.streak.days = newStreak;
            userData.streak.lastUpdated = newToday;

            // Reset for today's routines and move tomorrow's to today
            const tomorrowKey = new Date(new Date().setDate(new Date().getDate() + 1)).toISOString().slice(0, 10);
            userData.routines = userData.routines.filter(r => r.day !== yesterdayKey).map(r => {
                if (r.day === tomorrowKey) {
                    r.day = newToday;
                    r.completed = false; // Reset completion status for new day
                }
                return r;
            });
            
            userData.water = 0;
            userData.exercise = 0;
            saveState();
        }
        today = newToday;
    }
    
    setInterval(handleDailyReset, 60000);

    function renderAllTabs() {
        document.getElementById('home-tab').style.display = 'none';
        document.getElementById('profile-tab').style.display = 'none';
        document.getElementById('analytics-tab').style.display = 'none';

        document.getElementById(`${currentTab}-tab`).style.display = 'block';

        document.querySelectorAll('.tab-btn').forEach(btn => {
            if (btn.dataset.tab === currentTab) {
                btn.classList.add('text-blue-500');
            } else {
                btn.classList.remove('text-blue-500');
            }
        });

        if (currentTab === 'home') {
            renderTimetable();
            renderWaterGlasses();
            renderExercise();
        } else if (currentTab === 'profile') {
            renderProfile();
        } else if (currentTab === 'analytics') {
            renderAnalytics();
        }
    }

    function calculateTotalFocusTime(day = today) {
        let totalMinutes = 0;
        userData.routines.forEach(routine => {
            if (routine.day === day && routine.completed && routine.startTime && routine.endTime) {
                const [startH, startM] = routine.startTime.split(':').map(Number);
                const [endH, endM] = routine.endTime.split(':').map(Number);
                let durationMinutes = (endH * 60 + endM) - (startH * 60 + startM);
                if (durationMinutes < 0) {
                    durationMinutes += 24 * 60;
                }
                totalMinutes += durationMinutes;
            }
        });
        return totalMinutes;
    }

    function renderTimetable() {
        timetableList.innerHTML = '';
        const todayRoutines = userData.routines.filter(r => r.day === today);

        if (todayRoutines.length === 0) {
            timetableList.innerHTML = `<p class="text-center text-gray-500 italic">No routines for today. Click "Add New Routine" to begin!</p>`;
        }
        
        homeRoutineTitle.textContent = `Today's Routines`;
        todayRoutines.forEach((routine, index) => {
            const routineEl = document.createElement('div');
            routineEl.className = `bg-gray-700 p-4 rounded-xl flex items-center justify-between shadow-inner ${routine.completed ? 'opacity-50 line-through' : ''}`;
            routineEl.innerHTML = `
                <div>
                    <h3 class="text-lg font-semibold text-blue-300">${routine.name}</h3>
                    <p class="text-sm text-gray-400">${routine.startTime} - ${routine.endTime}</p>
                </div>
                ${!routine.completed ? `<button data-index="${index}" class="complete-routine-btn py-1 px-3 bg-green-500 hover:bg-green-600 transition-colors duration-200 rounded-2xl text-xs font-bold shadow">
                    Complete
                </button>` : ''}
            `;
            const completeBtn = routineEl.querySelector('.complete-routine-btn');
            if (completeBtn) {
                completeBtn.addEventListener('click', () => {
                    const routineIndex = userData.routines.findIndex(r => r.name === routine.name && r.day === today);
                    if (routineIndex !== -1) {
                         userData.routines[routineIndex].completed = true;
                         saveState();
                         renderTimetable();
                    }
                });
            }
            timetableList.appendChild(routineEl);
        });
    }

    function renderWaterGlasses() {
        waterGlassesContainer.innerHTML = '';
        const totalQuarters = Math.round(userData.water * 4);
        const totalGlassesNeeded = Math.ceil(totalQuarters / 4) || 1;
        
        for (let i = 0; i < totalGlassesNeeded; i++) {
            const glass = document.createElement('div');
            glass.className = 'glass-container';
            glass.innerHTML = `
                <div class="glass-lines">
                    <div class="glass-line"></div><div class="glass-line"></div><div class="glass-line"></div><div class="glass-line"></div>
                </div>
                <div class="glass-fill"></div>
            `;
            waterGlassesContainer.appendChild(glass);
        }

        const waterGlasses = document.querySelectorAll('.glass-container');
        waterGlasses.forEach((glass, glassIndex) => {
            let fillElement = glass.querySelector('.glass-fill');
            const glassQuarters = Math.max(0, Math.min(4, totalQuarters - (glassIndex * 4)));
            fillElement.style.height = `${glassQuarters * 25}%`;
        });
        waterCountDisplay.textContent = `${userData.water} glasses`;
    }

    function renderExercise() {
        const exerciseMins = userData.exercise || 0;
        const hours = Math.floor(exerciseMins / 60);
        const minutes = exerciseMins % 60;
        exerciseCountDisplay.textContent = `${hours}h ${minutes}m`;
    }

    function renderProfile() {
        document.getElementById('profile-username').textContent = userData.profile.username || 'Warrior';
        streakDays.innerHTML = '';
        userData.streak.days.forEach(dayStatus => {
            const dayEl = document.createElement('div');
            dayEl.className = 'flex flex-col items-center justify-center w-12 h-12 rounded-full border-2';
            if (dayStatus === 'lit') {
                dayEl.classList.add('bg-yellow-400', 'border-yellow-500', 'glow', 'text-yellow-900');
                dayEl.innerHTML = '<i class="fas fa-check"></i>';
            } else {
                dayEl.classList.add('bg-gray-700', 'border-gray-600', 'text-gray-400');
                dayEl.innerHTML = '<i class="fas fa-times"></i>';
            }
            streakDays.appendChild(dayEl);
        });
    }

    function renderAnalytics() {
        analyticsContent.innerHTML = '';
        const dailyData = userData.analytics.daily || {};
        const dates = Object.keys(dailyData).sort((a, b) => new Date(b) - new Date(a));
        
        const dailyReportsEl = document.createElement('div');
        dailyReportsEl.className = 'mb-8';
        dailyReportsEl.innerHTML = `<h3 class="text-xl font-bold text-blue-400 mb-4">Daily Reports</h3>`;
        
        dates.slice(0, 7).forEach((date, index) => {
            const day = new Date(date).toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
            const report = dailyData[date];
            const prevDate = dates[index + 1];
            const prevReport = dailyData[prevDate];
            
            let improvementMessage = '';
            if (prevReport) {
                const waterChange = (report.water - prevReport.water) / (prevReport.water || 1);
                const exerciseChange = (report.exercise - prevReport.exercise) / (prevReport.exercise || 1);
                const focusChange = (report.totalFocusTime - prevReport.totalFocusTime) / (prevReport.totalFocusTime || 1);
                const totalChange = waterChange + exerciseChange + focusChange;
                if (totalChange > 0) {
                    const improvementPercent = Math.min(100, Math.round(totalChange * 33));
                    improvementMessage = motivationalMessages[Math.floor(Math.random() * motivationalMessages.length)].replace('{percent}', improvementPercent);
                } else {
                    improvementMessage = "Keep pushing forward! You've got this.";
                }
            }
            
            dailyReportsEl.innerHTML += `
                <div class="bg-gray-700 p-4 rounded-xl mb-4 shadow-inner">
                    <h4 class="text-lg font-semibold text-gray-200">${day}</h4>
                    <p class="text-sm text-gray-400">Water: ${report.water || 0} glasses, Exercise: ${report.exercise || 0} mins, Routines: ${report.routinesCompleted || 0}</p>
                    <p class="text-sm">Total Focus Time: ${Math.floor((report.totalFocusTime || 0) / 60)}h ${Math.round((report.totalFocusTime || 0) % 60)}m</p>
                    ${improvementMessage ? `<p class="text-sm italic text-green-400 mt-2">${improvementMessage}</p>` : ''}
                </div>
            `;
        });
        
        analyticsContent.appendChild(dailyReportsEl);

        const weeklyReportsEl = document.createElement('div');
        weeklyReportsEl.innerHTML = `<h3 class="text-xl font-bold text-blue-400 mb-4">Weekly Report</h3>`;
        
        const weekDates = Object.keys(dailyData).sort((a,b) => new Date(a) - new Date(b)).slice(-7);
        const weeklyWaterData = weekDates.map(date => dailyData[date]?.water || 0);

        const weeklyChartEl = document.createElement('div');
        weeklyChartEl.className = 'bar-chart-container';
        
        weeklyWaterData.forEach((value) => {
            const bar = document.createElement('div');
            const height = (value / 8) * 100;
            bar.className = `bar`;
            bar.style.height = `${Math.min(100, height)}%`;
            weeklyChartEl.appendChild(bar);
        });
        weeklyReportsEl.appendChild(weeklyChartEl);
        analyticsContent.appendChild(weeklyReportsEl);
    }

    // --- EVENT LISTENERS ---
    loginForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const username = usernameInput.value.trim();
        if (username) {
            userData.profile.username = username;
            userLoggedIn = true;
            saveState();
            loginModal.style.display = 'none';
            appContainer.classList.remove('hidden');
            handleDailyReset();
            renderAllTabs();
            document.querySelector('.tab-btn').classList.add('text-blue-500');
        }
    });

    document.querySelectorAll('.tab-btn').forEach(button => {
        button.addEventListener('click', (e) => {
            currentTab = e.currentTarget.dataset.tab;
            renderAllTabs();
        });
    });

    addRoutineBtn.addEventListener('click', () => {
        routineModal.style.display = 'flex';
        // Set default day to today
        const todayDate = new Date();
        const tomorrowDate = new Date(todayDate);
        tomorrowDate.setDate(tomorrowDate.getDate() + 1);
        routineDaySelect.innerHTML = `
            <option value="${todayDate.toISOString().slice(0, 10)}">Today</option>
            <option value="${tomorrowDate.toISOString().slice(0, 10)}">Tomorrow</option>
        `;
    });
    closeRoutineModalBtn.addEventListener('click', () => {
        routineModal.style.display = 'none';
    });

    routineForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const routineName = document.getElementById('routine-name').value;
        const startTime = document.getElementById('start-time').value;
        const endTime = document.getElementById('end-time').value;
        const alarmMessage = document.getElementById('alarm-message').value || "You are running out of time, start your revision now!";
        const routineDay = document.getElementById('routine-day').value;
        userData.routines.push({ name: routineName, startTime, endTime, message: alarmMessage, completed: false, day: routineDay });
        saveState();
        routineModal.style.display = 'none';
        renderAllTabs();
    });

    drinkWaterBtn.addEventListener('click', () => {
        if (userData.water < 16) {
            userData.water = parseFloat((userData.water + 0.25).toFixed(2));
            saveState();
            renderWaterGlasses();
        }
    });

    document.getElementById('add-exercise-btn').addEventListener('click', () => {
        const exerciseTime = document.getElementById('exercise-time-input').value;
        if (exerciseTime > 0) {
            userData.exercise += parseInt(exerciseTime, 10);
            saveState();
            document.getElementById('exercise-time-input').value = '';
            renderExercise();
        }
    });

    document.getElementById('logout-btn').addEventListener('click', () => {
        localStorage.removeItem('userData');
        window.location.reload();
    });

    const closeAlarmBtn = document.getElementById('close-alarm-btn');
    const alarmInterval = setInterval(checkAlarms, 1000);
    const burnoutInterval = setInterval(() => {
        if (userLoggedIn && Math.random() > 0.9 && userData.routines.length > 0) {
            showBurnoutMessage();
        }
    }, 1200000);

    function showAlarm(message) {
        if (Notification.permission === "granted") {
            new Notification("Time to Rise!", { body: message });
        }
        alarmMessageEl.textContent = message;
        alarmModal.style.display = 'flex';
    }

    closeAlarmBtn.addEventListener('click', () => {
        alarmModal.style.display = 'none';
    });
    
    function checkAlarms() {
        if (!userLoggedIn) return;
        const now = new Date();
        const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
        userData.routines.forEach(routine => {
            const routineDay = routine.day ? routine.day : today;
            if (routineDay === today && routine.startTime === currentTime && !routine.completed && !notifiedRoutines[routine.startTime]) {
                showAlarm(routine.message);
                notifiedRoutines[routine.startTime] = true;
            }
        });
    }

    function showBurnoutMessage() {
        burnoutMessageEl.classList.remove('hidden');
        setTimeout(() => {
            burnoutMessageEl.classList.add('hidden');
        }, 10000);
    }

    async function init() {
        if ("Notification" in window && Notification.permission !== 'granted') {
            await Notification.requestPermission();
        }
        
        const savedData = loadState();
        if (savedData) {
            userData = savedData;
            userLoggedIn = true;
            loadingScreen.classList.add('hidden');
            appContainer.classList.remove('hidden');
            handleDailyReset();
            renderAllTabs();
            document.querySelector('.tab-btn').classList.add('text-blue-500');
        } else {
            loadingScreen.classList.add('hidden');
            loginModal.style.display = 'flex';
        }
        
        const randomQuote = motivationalQuotes[Math.floor(Math.random() * motivationalQuotes.length)];
        quoteOfTheDayEl.textContent = randomQuote;
    }
    
    window.onload = init;
</script>
</html>
